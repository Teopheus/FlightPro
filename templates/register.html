{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

<div class="mb-4">
    <h2 class="page-title">{{ 'Editar Oferta' if search else 'Nova Oferta' }}</h2>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card-custom border-0 shadow-sm">
            <form id="flightForm" action="{{ url_for('edit_search', id=search['id']) if search else url_for('register') }}" method="POST">
                
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="bi bi-airplane-fill"></i>
                    </div>
                    <h5 class="fw-bold mb-0 text-dark">Dados Gerais (Voo 1)</h5>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="origin" placeholder="Origem" required value="{{ search['origin'] if search else '' }}">
                            <label>Origem (Ex: GRU)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="destination" placeholder="Destino" required value="{{ search['destination'] if search else '' }}">
                            <label>Destino (Ex: LIS)</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-floating">
                            <input type="text" class="form-control" name="operator" placeholder="Operador" value="{{ search['operator'] if search else '' }}">
                            <label>Companhia Aérea</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select" name="flight_type">
                                <option value="Executiva" {{ 'selected' if search and search['flight_type'] == 'Executiva' else '' }}>Executiva</option>
                                <option value="Econômica" {{ 'selected' if search and search['flight_type'] == 'Econômica' else '' }}>Econômica</option>
                                <option value="Primeira Classe" {{ 'selected' if search and search['flight_type'] == 'Primeira Classe' else '' }}>Primeira Classe</option>
                            </select>
                            <label>Classe</label>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="flightTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active fw-bold" id="opt1-tab" data-bs-toggle="tab" data-bs-target="#opt1" type="button">① Opção 1 (Ida)</button></li>
                    <li class="nav-item"><button class="nav-link fw-bold text-muted" id="opt2-tab" data-bs-toggle="tab" data-bs-target="#opt2" type="button">② Opção 2 (Volta/Alt)</button></li>
                </ul>

                <div class="tab-content border-bottom mb-4 pb-4" id="flightTabsContent">
                    
                    <div class="tab-pane fade show active" id="opt1">
                        
                        <div id="prices-container-1"></div>
                        
                        <button type="button" class="btn btn-sm btn-outline-primary mb-4" onclick="addPriceRow(1)">
                            <i class="bi bi-plus-lg me-1"></i> Adicionar Outra Tarifa
                        </button>

                        <div class="bg-light p-3 rounded border">
                            <div class="row align-items-end mb-2">
                                <div class="col-md-9">
                                    <label class="small fw-bold text-muted mb-1"><i class="bi bi-calendar-event me-1"></i>Datas Disponíveis</label>
                                    <input type="text" id="calendarPicker1" class="form-control" placeholder="Clique para selecionar datas...">
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold text-muted mb-1">Vagas</label>
                                    <input type="number" id="seats_1" class="form-control text-center fw-bold" value="2" min="1">
                                </div>
                            </div>
                            <textarea id="dates_1" name="dates_1" class="form-control text-muted" rows="4" style="font-family: monospace;">{{ search['dates_1'] if search else (search['available_dates'] if search else '') }}</textarea>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="opt2">
                        <div class="alert alert-light border small text-muted mb-3 d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2 text-info"></i> 
                            Preencha se houver um segundo trecho (Volta) ou outra tarifa.
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" name="origin_2" value="{{ search['origin_2'] if search else '' }}"><label>Origem</label></div></div>
                            <div class="col-md-6"><div class="form-floating"><input type="text" class="form-control" name="destination_2" value="{{ search['destination_2'] if search else '' }}"><label>Destino</label></div></div>
                        </div>

                        <div id="prices-container-2"></div>
                        
                        <button type="button" class="btn btn-sm btn-outline-primary mb-4" onclick="addPriceRow(2)">
                            <i class="bi bi-plus-lg me-1"></i> Adicionar Outra Tarifa
                        </button>

                        <div class="bg-light p-3 rounded border">
                            <div class="row align-items-end mb-2">
                                <div class="col-md-9">
                                    <label class="small fw-bold text-muted mb-1"><i class="bi bi-calendar-event me-1"></i>Datas (Opção 2)</label>
                                    <input type="text" id="calendarPicker2" class="form-control" placeholder="Clique para selecionar datas...">
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold text-muted mb-1">Vagas</label>
                                    <input type="number" id="seats_2" class="form-control text-center fw-bold" value="2" min="1">
                                </div>
                            </div>
                            <textarea id="dates_2" name="dates_2" class="form-control text-muted" rows="4" style="font-family: monospace;">{{ search['dates_2'] if search else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-floating w-50 me-3">
                        <input type="text" class="form-control" id="search_date" name="search_date" placeholder="DD/MM/AAAA" required value="{{ search['search_date'] if search else '' }}">
                         <label>Data da Pesquisa (DD/MM/AAAA)</label>
                    </div>
                    <button type="submit" class="btn btn-primary-custom btn-lg w-50 shadow-sm">
                        <i class="bi bi-check2-circle me-2"></i> {{ 'Salvar Alterações' if search else 'Gerar Oferta' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Gera as opções dos selects uma única vez via Jinja2
    const PROGRAM_OPTIONS = `{% for p in programs %}<option value="{{ p.id }}">{{ p.name }}</option>{% endfor %}`;
    const CURRENCY_OPTIONS = `{% for c in currencies %}<option value="{{ c.id }}">{{ c.code }}</option>{% endfor %}`;
    
    // Recupera dados salvos do backend (caso seja edição) ou array vazio
    const SAVED_PRICES_1 = {{ search.prices_1 | tojson if search and search.prices_1 else '[]' }};
    const SAVED_PRICES_2 = {{ search.prices_2 | tojson if search and search.prices_2 else '[]' }};
</script>

<script>
    // --- FUNÇÕES DE PREÇOS DINÂMICOS ---
    function addPriceRow(optIndex, data = null) {
        const container = document.getElementById(`prices-container-${optIndex}`);
        const rowId = Date.now() + Math.random().toString(16).slice(2); // ID único
        
        // Valores iniciais (se for edição ou vazio)
        const milesVal = data ? data.miles : '';
        const progVal = data ? data.prog_id : '';
        const taxVal = data ? data.tax : '';
        const currVal = data ? data.curr_id : '';

        const html = `
        <div class="card mb-2 border bg-light position-relative" id="row-${rowId}">
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2 small" aria-label="Remover" onclick="removeRow('${rowId}')" style="z-index: 5;"></button>
            <div class="card-body p-3">
                <div class="row g-2">
                    <div class="col-md-7">
                        <label class="small text-muted mb-1">Milhas + Programa</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="miles_${optIndex}[]" placeholder="Ex: 65000" value="${milesVal}">
                            <select class="form-select" name="prog_${optIndex}[]" style="max-width: 150px;">
                                <option value="">Programa...</option>
                                ${PROGRAM_OPTIONS}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="small text-muted mb-1">Taxas</label>
                        <div class="input-group">
                            <select class="form-select bg-white" name="curr_${optIndex}[]" style="max-width: 90px;">
                                ${CURRENCY_OPTIONS}
                            </select>
                            <input type="text" class="form-control" name="tax_${optIndex}[]" placeholder="150,00" value="${taxVal}">
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', html);
        
        // Define os valores selecionados nos dropdowns
        if(data) {
            const lastRow = document.getElementById(`row-${rowId}`);
            if(progVal) lastRow.querySelector(`select[name="prog_${optIndex}[]"]`).value = progVal;
            if(currVal) lastRow.querySelector(`select[name="curr_${optIndex}[]"]`).value = currVal;
        }
    }

    function removeRow(rowId) {
        const row = document.getElementById(`row-${rowId}`);
        if(row) row.remove();
    }

    // --- LÓGICA DO CALENDÁRIO ---
    function setupCalendar(pickerId, outputId, seatsId) {
        const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
        flatpickr(pickerId, {
            mode: "multiple", dateFormat: "d/m/Y", locale: "pt", minDate: "today", showMonths: 1,
            onChange: function(selectedDates) {
                if (selectedDates.length === 0) { document.querySelector(outputId).value = ""; return; }
                selectedDates.sort((a, b) => a - b);
                
                let seatsVal = document.querySelector(seatsId).value;
                let seatSuffix = seatsVal ? `(${seatsVal})` : "";
                
                let groups = {};
                selectedDates.forEach(date => {
                    let monthTag = monthNames[date.getMonth()];
                    let day = date.getDate();
                    if (!groups[monthTag]) groups[monthTag] = [];
                    groups[monthTag].push(day + seatSuffix);
                });
                
                let finalString = "";
                for (let [month, days] of Object.entries(groups)) {
                    finalString += `${month}: ${days.join(', ')}\n`;
                }
                document.querySelector(outputId).value = finalString.trim();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupCalendar("#calendarPicker1", "#dates_1", "#seats_1");
        setupCalendar("#calendarPicker2", "#dates_2", "#seats_2");
        
        const dateInput = document.getElementById('search_date');
        flatpickr(dateInput, {
            dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y", locale: "pt", allowInput: true,
            defaultDate: dateInput.value || new Date()
        });

        // --- INICIALIZAÇÃO DE PREÇOS ---
        // Opção 1 (Ida)
        if (SAVED_PRICES_1.length > 0) {
            SAVED_PRICES_1.forEach(p => addPriceRow(1, p));
        } else {
            addPriceRow(1); // Cria pelo menos uma linha vazia
        }

        // Opção 2 (Volta)
        if (SAVED_PRICES_2.length > 0) {
            SAVED_PRICES_2.forEach(p => addPriceRow(2, p));
        } else {
            addPriceRow(2); // Cria linha vazia padrão
        }
    });
</script>
{% endblock %}