{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

<div class="mb-4">
    <h2 class="page-title">{{ 'Editar Oferta' if search else 'Nova Oferta' }}</h2>
</div>

<div class="row g-4">
    <div class="col-lg-7">
        <div class="card-custom border-0 shadow-sm">
            <form id="flightForm" action="{{ url_for('edit_search', id=search['id']) if search else url_for('register') }}" method="POST">
                
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                        <i class="bi bi-airplane-fill"></i>
                    </div>
                    <h5 class="fw-bold mb-0 text-dark">Dados Gerais (Voo 1)</h5>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control live-input" id="origin" name="origin" placeholder="Origem" required value="{{ search['origin'] if search else '' }}">
                            <label>Origem (Ex: GRU)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            <input type="text" class="form-control live-input" id="destination" name="destination" placeholder="Destino" required value="{{ search['destination'] if search else '' }}">
                            <label>Destino (Ex: LIS)</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-floating">
                            <input type="text" class="form-control live-input" id="operator" name="operator" placeholder="Operador" value="{{ search['operator'] if search else '' }}">
                            <label>Companhia A√©rea</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating">
                            <select class="form-select live-input" id="flight_type" name="flight_type">
                                <option value="Executiva" {{ 'selected' if search and search['flight_type'] == 'Executiva' else '' }}>Executiva</option>
                                <option value="Econ√¥mica" {{ 'selected' if search and search['flight_type'] == 'Econ√¥mica' else '' }}>Econ√¥mica</option>
                                <option value="Primeira Classe" {{ 'selected' if search and search['flight_type'] == 'Primeira Classe' else '' }}>Primeira Classe</option>
                            </select>
                            <label>Classe</label>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="flightTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold" id="opt1-tab" data-bs-toggle="tab" data-bs-target="#opt1" type="button" role="tab">
                            <i class="bi bi-1-circle me-1"></i> Op√ß√£o 1 (Ida)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold text-muted" id="opt2-tab" data-bs-toggle="tab" data-bs-target="#opt2" type="button" role="tab">
                            <i class="bi bi-2-circle me-1"></i> Op√ß√£o 2 (Volta/Alt)
                        </button>
                    </li>
                </ul>

                <div class="tab-content border-bottom mb-4 pb-4" id="flightTabsContent">
                    
                    <div class="tab-pane fade show active" id="opt1" role="tabpanel">
                        <div class="row g-3 mb-3">
                            <div class="col-md-7">
                                <div class="form-floating">
                                    <textarea class="form-control live-input" id="program_1" name="program_1" placeholder="Programa" style="height: 100px; font-family: monospace; font-size: 0.9rem;">{{ search['program_1'] if search else (search['program'] if search else '') }}</textarea>
                                    <label>Programa + Milhas</label>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-floating">
                                    <input type="text" class="form-control live-input" id="cost_1" name="cost_1" placeholder="Custo" value="{{ search['cost_1'] if search else (search['cost'] if search else '') }}">
                                    <label>Taxas/Custo</label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-light p-3 rounded border">
                            <div class="row align-items-end mb-2">
                                <div class="col-md-9">
                                    <label class="small fw-bold text-muted mb-1"><i class="bi bi-calendar-event me-1"></i>Datas Dispon√≠veis</label>
                                    <input type="text" id="calendarPicker1" class="form-control" placeholder="Clique para selecionar datas...">
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold text-muted mb-1">Vagas</label>
                                    <input type="number" id="seats_1" class="form-control text-center fw-bold" value="2" min="1">
                                </div>
                            </div>
                            <textarea id="dates_1" name="dates_1" class="form-control live-input text-muted" rows="4" style="font-family: monospace; font-size: 0.9rem; background: #fff;" placeholder="As datas aparecer√£o aqui...">{{ search['dates_1'] if search else (search['available_dates'] if search else '') }}</textarea>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="opt2" role="tabpanel">
                        <div class="alert alert-light border small text-muted mb-3 d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2 text-info"></i> 
                            Preencha se houver um segundo trecho (Volta) ou outra tarifa.
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control live-input" id="origin_2" name="origin_2" placeholder="Origem" value="{{ search['origin_2'] if search else '' }}">
                                    <label>Origem (Volta)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control live-input" id="destination_2" name="destination_2" placeholder="Destino" value="{{ search['destination_2'] if search else '' }}">
                                    <label>Destino (Volta)</label>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-md-7">
                                <div class="form-floating">
                                    <textarea class="form-control live-input" id="program_2" name="program_2" placeholder="Programa" style="height: 100px; font-family: monospace; font-size: 0.9rem;">{{ search['program_2'] if search else '' }}</textarea>
                                    <label>Programa + Milhas (Op√ß√£o 2)</label>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-floating">
                                    <input type="text" class="form-control live-input" id="cost_2" name="cost_2" placeholder="Custo" value="{{ search['cost_2'] if search else '' }}">
                                    <label>Taxas/Custo (Op√ß√£o 2)</label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-light p-3 rounded border">
                            <div class="row align-items-end mb-2">
                                <div class="col-md-9">
                                    <label class="small fw-bold text-muted mb-1"><i class="bi bi-calendar-event me-1"></i>Datas (Op√ß√£o 2)</label>
                                    <input type="text" id="calendarPicker2" class="form-control" placeholder="Clique para selecionar datas...">
                                </div>
                                <div class="col-md-3">
                                    <label class="small fw-bold text-muted mb-1">Vagas</label>
                                    <input type="number" id="seats_2" class="form-control text-center fw-bold" value="2" min="1">
                                </div>
                            </div>
                            <textarea id="dates_2" name="dates_2" class="form-control live-input text-muted" rows="4" style="font-family: monospace; font-size: 0.9rem; background: #fff;" placeholder="As datas aparecer√£o aqui...">{{ search['dates_2'] if search else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-floating w-50 me-3">
                        <input type="text" class="form-control live-input" id="search_date" name="search_date" placeholder="DD/MM/AAAA" required value="{{ search['search_date'] if search else '' }}">
                         <label>Data da Pesquisa (DD/MM/AAAA)</label>
                    </div>
                    <button type="submit" class="btn btn-primary-custom btn-lg w-50 shadow-sm">
                        <i class="bi bi-check2-circle me-2"></i> {{ 'Salvar Altera√ß√µes' if search else 'Gerar Oferta' }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="sticky-top" style="top: 20px;">
            <div class="card border-0 text-white text-center p-3 shadow-lg" style="background-color: var(--sidebar-bg); border-radius: 16px;">
                <h6 class="mb-3 text-white-50 text-uppercase fw-bold" style="font-size: 0.75rem; letter-spacing: 1px;">
                    <i class="bi bi-eye me-2"></i>Visualiza√ß√£o
                </h6>
                <div class="position-relative bg-white rounded-3 overflow-hidden shadow-sm mx-auto">
                    <img id="previewImage" src="{{ url_for('static', filename='generated/' + search['image_path']) if search else '' }}" class="img-fluid w-100" style="opacity: 0.8; transition: opacity 0.3s;">
                    <div id="loadingSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
                
                <div class="mt-3 d-grid gap-2">
                    <button type="button" class="btn btn-outline-light btn-sm opacity-75" onclick="updatePreview()">
                        <i class="bi bi-arrow-repeat"></i> Atualizar
                    </button>
                    <button type="button" class="btn btn-success fw-bold shadow-sm" onclick="copyImageToClipboard()">
                        <i class="bi bi-whatsapp me-2"></i>Copiar Imagem
                    </button>
                    <button type="button" class="btn btn-dark bg-opacity-50 border-0 btn-sm" onclick="copyCaption()">
                        <i class="bi bi-card-text me-2"></i>Copiar Legenda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DO CALEND√ÅRIO COM VAGAS ---
    function setupCalendar(pickerId, outputId, seatsId) {
        const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
        
        flatpickr(pickerId, {
            mode: "multiple",
            dateFormat: "d/m/Y", // Visual do picker
            locale: "pt",
            minDate: "today",
            showMonths: 1,
            onChange: function(selectedDates) {
                if (selectedDates.length === 0) {
                    document.querySelector(outputId).value = "";
                    updatePreview();
                    return;
                }
                selectedDates.sort((a, b) => a - b);
                
                // Pega vagas
                let seatsVal = document.querySelector(seatsId).value;
                let seatSuffix = seatsVal ? `(${seatsVal})` : "";

                let groups = {};
                selectedDates.forEach(date => {
                    let monthTag = monthNames[date.getMonth()];
                    let day = date.getDate();
                    if (!groups[monthTag]) groups[monthTag] = [];
                    groups[monthTag].push(day + seatSuffix);
                });

                let finalString = "";
                for (let [month, days] of Object.entries(groups)) {
                    finalString += `${month}: ${days.join(', ')}\n`;
                }
                document.querySelector(outputId).value = finalString.trim();
                updatePreview();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        setupCalendar("#calendarPicker1", "#dates_1", "#seats_1");
        setupCalendar("#calendarPicker2", "#dates_2", "#seats_2");

        // --- CONFIGURA√á√ÉO ESPECIAL PARA DATA DA PESQUISA ---
        // Isso garante que voc√™ veja DD/MM/AAAA, mas o servidor receba AAAA-MM-DD
        const dateInput = document.getElementById('search_date');
        
        flatpickr(dateInput, {
            dateFormat: "Y-m-d", // Formato REAL (que vai pro banco)
            altInput: true,      // Habilita o campo visual alternativo
            altFormat: "d/m/Y",  // Formato VISUAL (que voc√™ v√™)
            locale: "pt",
            allowInput: true,    // Permite digitar manualmente
            defaultDate: dateInput.value || new Date() // Mant√©m valor antigo ou p√µe hoje
        });

        if (!dateInput.value) {
            updatePreview(); 
        }
    });

    // --- PREVIEW E UTILIT√ÅRIOS ---
    function debounce(func, timeout = 600){
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    async function updatePreview() {
        const spinner = document.getElementById('loadingSpinner');
        const img = document.getElementById('previewImage');
        spinner.classList.remove('d-none');
        img.style.opacity = '0.4';

        const formData = {
            origin: document.getElementById('origin').value,
            destination: document.getElementById('destination').value,
            operator: document.getElementById('operator').value,
            flight_type: document.getElementById('flight_type').value,
            search_date: document.getElementById('search_date').value,
            
            program_1: document.getElementById('program_1').value,
            cost_1: document.getElementById('cost_1').value,
            dates_1: document.getElementById('dates_1').value,
            
            program_2: document.getElementById('program_2').value,
            cost_2: document.getElementById('cost_2').value,
            dates_2: document.getElementById('dates_2').value,
            
            // NOVOS CAMPOS
            origin_2: document.getElementById('origin_2').value,
            destination_2: document.getElementById('destination_2').value
        };

        try {
            const response = await fetch('/api/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            const data = await response.json();
            if (data.image) {
                img.src = "data:image/png;base64," + data.image;
                img.style.opacity = '1';
            }
        } catch (error) { console.error(error); } 
        finally { spinner.classList.add('d-none'); }
    }
    
    async function copyImageToClipboard() {
        const img = document.getElementById('previewImage');
        if (!img.src.includes('data:image')) { alert("Gere o preview primeiro!"); return; }
        try {
            const res = await fetch(img.src);
            const blob = await res.blob();
            await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
            alert("Copiado com sucesso!");
        } catch (e) { alert("Erro ao copiar (Use HTTPS ou Localhost)."); }
    }

    function copyCaption() {
        const origin = document.getElementById('origin').value;
        const dest = document.getElementById('destination').value;
        const op = document.getElementById('operator').value;
        const cost1 = document.getElementById('cost_1').value;
        const prog1 = document.getElementById('program_1').value.split('\n')[0] || "Pontos";

        const caption = `‚úàÔ∏è *OFERTA: ${origin} ‚ûù ${dest}* ‚úàÔ∏è\n\n` +
            `üè¢ *Cia:* ${op}\n` +
            `üíé *Valor:* ${prog1} + R$ ${cost1}\n\n` +
            `üìÖ *Datas e Vagas na Imagem!*\n` +
            `üì≤ _Chame para emitir!_`;
        
        navigator.clipboard.writeText(caption).then(() => alert("Legenda copiada!"));
    }

    const inputs = document.querySelectorAll('.live-input');
    const processChange = debounce(() => updatePreview());
    inputs.forEach(input => {
        input.addEventListener('input', processChange);
        input.addEventListener('change', processChange);
    });
</script>
{% endblock %}